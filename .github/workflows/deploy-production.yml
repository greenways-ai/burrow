name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

jobs:
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'deploy' || github.ref_type == 'tag' || github.event_name == 'push'
    
    steps:
    - name: Verify branch/tag
      run: |
        echo "Deploying from: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"

  deploy-supabase:
    name: Deploy Supabase to Production
    runs-on: ubuntu-latest
    environment: production
    needs: verify
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest
        
    - name: Link Supabase project
      run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        
    - name: Push database migrations
      run: supabase db push
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  deploy-netlify:
    name: Deploy to Netlify Production
    runs-on: ubuntu-latest
    environment: production
    needs: [verify, deploy-supabase]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Create .env.local
      run: |
        cat > .env.local << 'EOF'
        NEXT_PUBLIC_APP_URL=https://burrow.greenways.ai
        NEXT_PUBLIC_APP_DOMAIN=burrow.greenways.ai
        NEXT_PUBLIC_SITE_NAME=burrow-greenways-ai
        NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID=${{ secrets.WALLET_CONNECT_PROJECT_ID }}
        NEXT_PUBLIC_ENCRYPTION_SALT=${{ secrets.ENCRYPTION_SALT }}
        NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
        KIMI_API_KEY=${{ secrets.KIMI_API_KEY }}
        KIMI_MODEL=kimi-k2-0711-longcontext
        EOF
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build and Deploy to Netlify
      run: |
        npm install -g netlify-cli
        netlify deploy --prod --build --site=${{ secrets.NETLIFY_SITE_ID }}
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
